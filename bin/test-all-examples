#!/bin/bash

set -e

if [ $# -eq 0 ]; then
    echo "usage: $0 /path/to/exercise"
    exit 1
fi

exercisedir=$1

if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
    current_branch="$TRAVIS_BRANCH"
else
    current_branch="$TRAVIS_PULL_REQUEST_BRANCH"
fi

if [ "$current_branch" != "master" ]; then
    # Exit early if exercise has not been changed
    changed_exercises="$(git diff --name-only "${TRAVIS_COMMIT_RANGE/.../..}" | grep "exercises/" | cut -d '/' -f -2 | sort | uniq)"
    # Format: exercises/clock
    for changed_exercise in changed_exercises; do
	# If changed_exercise is suffix of exercisedir
	case $changed_exercise in "$exercisedir"*)
	    exercise_changed=1
	esac
    done
    if [[ -z "$exercise_changed" ]]; then
	echo "exercise not modified."
	exit 0
    fi
fi

if ! stat -t ${exercisedir}/examples/*/ > /dev/null 2>&1; then
    echo "No examples for ${exercisedir}!"
    exit 1
else
    mydir=$(dirname $0)
    for example in ${exercisedir}/examples/*/ ; do
        $mydir/test-example $example
    done
fi
